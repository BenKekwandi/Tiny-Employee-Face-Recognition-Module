{% extends 'layout.html' %}

{% block content %}

<div
style="border:1px solid green"
width="650" height="500"
>
<video id="video" width="640" height="480"></video>
  <canvas id="canvas" width="640" height="480"></canvas>
</div>
    
    <script>
      var video = document.querySelector("#video");
      var canvas = document.querySelector("#canvas");
      var ctx = canvas.getContext("2d");

      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function (stream) {
          video.srcObject = stream;
          video.play();
        })
        .catch(function (err) {
          console.log("An error occurred: " + err);
        });
    
      function capture() 
      {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        var dataURL = canvas.toDataURL("image/png");
        var csrftoken = getCookie('csrftoken');
        console.log(dataURL);
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/test', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('X-CSRFToken', csrftoken);
        xhr.onreadystatechange = function() 
        {
          if (xhr.readyState === 4 && xhr.status === 200)
          {
            console.log(xhr.responseText);
          }
        };
        xhr.send('image=' + encodeURIComponent(dataURL));
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
              var result = xhr.responseText;
              var div = document.getElementById("result");
              div.innerHTML = result;
          }
      };
      }
      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      var detectFaces = function() {
        //ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var src = cv.matFromImageData(imageData);
        var gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
        var faces = new cv.RectVector();
        var classifier = new cv.CascadeClassifier();
        classifier.load('haarcascade_frontalface_default.xml');
        classifier.detectMultiScale(gray, faces, 1.1, 3, 0);
        for (var i = 0; i < faces.size(); ++i) {
          var face = faces.get(i);
          ctx.strokeStyle = 'red';
          ctx.lineWidth = 3;
          ctx.strokeRect(face.x, face.y, face.width, face.height);
        }
        src.delete();
        gray.delete();
        faces.delete();
        classifier.delete();
      }
      
      // Call detectFaces every second
      setInterval(detectFaces, 1000);

    </script>
    <button onclick="capture()" class="btn btn-outline-success">Capture</button>

{% endblock %}